name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Removed the 'Set up SSH' step using webfactory/ssh-agent. 
      # The appleboy/ssh-action handles the key directly.

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          # The appleboy/ssh-action is designed to accept the key directly for connection.
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Optional: You can specify a working directory if needed, 
          # but for a full deployment script like this, it's often best to handle directories inside the script.
          # working-directory: /home/${{ secrets.SSH_USER }}
          script: |
            # Exit immediately if a command exits with a non-zero status.
            # Exit if any command in a pipeline fails.
            set -euo pipefail

            PROJECT_DIR="/home/${{ secrets.SSH_USER }}/project"

            echo "Stopping old containers if any..."
            # Use '|| true' to prevent script failure if containers/network don't exist
            docker rm -f academicpro-backend academicpro-frontend || true
            docker network prune -f || true

            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              # Ensure to use the correct compose command (might be 'docker compose' or 'docker-compose')
              # Assuming 'docker compose' is installed and correct for modern systems.
              docker compose down --volumes --remove-orphans || true
            fi

            echo "Removing old project folder..."
            # Use a check to ensure you don't delete an important directory by mistake
            if [ -d "$PROJECT_DIR" ]; then
              rm -rf "$PROJECT_DIR"
            fi

            echo "Cloning fresh repository..."
            # Using 'git clone' inside the script requires that the remote server has 
            # SSH keys or HTTPS access to the repository, which is often the case for public repos.
            git clone https://github.com/MiniduOshan/AcademicPro.git "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            # --- Environment variables setup ---
            # Define them here for clarity inside the SSH script context
            PORT=5000
            MONGO_URI="${{ secrets.MONGO_URI }}"
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            CORS_ORIGIN="http://4.240.89.33"
            VITE_API_URL="http://4.240.89.33:5000/api"

            # Creating backend .env file
            echo "Creating backend .env file..."
            cat > backend/.env <<EOF
PORT=$PORT
MONGO_URI=$MONGO_URI
JWT_SECRET=$JWT_SECRET
CORS_ORIGIN=$CORS_ORIGIN
EOF

            # Creating frontend .env.production
            echo "Creating frontend .env.production..."
            cat > frontend/.env.production <<EOF
VITE_API_URL=$VITE_API_URL
EOF

            # Verification (Optional but good practice)
            echo "Verifying .env files..."
            cat backend/.env
            cat frontend/.env.production

            echo "Starting Docker Compose..."
            docker compose up -d --build --force-recreate
            echo "Deployment completed successfully!"