name: MERN Deployment to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_IP_ADDRESS }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          # optional: set port if not 22
          # port: ${{ secrets.VM_SSH_PORT }}
          script: |
            set -e

            # 0. Ensure Node.js and PM2 exist
            if ! command -v node >/dev/null 2>&1; then
              echo "Node.js not found. Please install Node.js >= 18 on the VM."
              exit 1
            fi
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "PM2 not found. Installing globally..."
              sudo npm i -g pm2
            fi

            # 1. Ensure repo is present in ~/AcademicPro
            if [ ! -d "$HOME/AcademicPro/.git" ]; then
              echo "Repository not found in ~/AcademicPro. Cloning..."
              if [ -z "${{ secrets.VM_REPO_URL }}" ]; then
                echo "VM_REPO_URL secret not set. Please add a HTTPS git URL to secrets."
                exit 1
              fi
              rm -rf "$HOME/AcademicPro"
              git clone "${{ secrets.VM_REPO_URL }}" "$HOME/AcademicPro"
            fi
            cd "$HOME/AcademicPro"

            # 2. Pull the latest code
            git pull origin main

            # 3. Setup Backend
            echo "Updating Backend..."
            cd backend
            npm ci || npm install
            # Restart backend using PM2
            pm2 restart academic-backend || pm2 start server.js --name "academic-backend" --update-env
            
            # 4. Setup Frontend
            echo "Updating Frontend..."
            cd ../frontend
            npm ci || npm install
            npm run build
            
            # 5. Move build files to Nginx web root (if applicable)
            if [ -d dist ]; then
              sudo mkdir -p /var/www/html
              sudo rm -rf /var/www/html/*
              sudo cp -r dist/* /var/www/html/
              sudo chown -R www-data:www-data /var/www/html || true
              sudo systemctl reload nginx || true
            fi
            
            echo "âœ… Deployment Successful"