name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Deploy to Azure VM via SSH
      - name: Deploy to Azure VM
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          script: |
            PROJECT_DIR="/home/${{ secrets.AZURE_VM_USER }}/project"

            echo "==> Removing existing project folder..."
            rm -rf $PROJECT_DIR

            echo "==> Cloning fresh code..."
            git clone https://github.com/MiniduOshan/AcademicPro.git $PROJECT_DIR

            cd $PROJECT_DIR

            echo "==> Creating .env file for backend..."
            cat <<EOF > $PROJECT_DIR/backend/.env
            PORT=${{ secrets.PORT }}
            MONGO_URI=${{ secrets.MONGO_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            EOF

            echo "==> Creating Docker network..."
            docker network create academicpro-network || true

            echo "==> Building Docker images..."
            docker build -t academicpro-backend ./backend
            docker build -t academicpro-frontend ./frontend

            echo "==> Stopping old containers..."
            docker stop academicpro-backend || true
            docker stop academicpro-frontend || true

            echo "==> Removing old containers..."
            docker rm academicpro-backend || true
            docker rm academicpro-frontend || true

            echo "==> Starting backend container..."
            docker run -d \
              --name academicpro-backend \
              --env-file $PROJECT_DIR/backend/.env \
              --network academicpro-network \
              -p 5000:5000 \
              academicpro-backend

            echo "==> Starting frontend container..."
            docker run -d \
              --name academicpro-frontend \
              --network academicpro-network \
              -p 80:80 \
              -e VITE_API_URL=http://4.240.89.33:5000 \
              academicpro-frontend

            echo "==> Deployment completedÂ successfully!"